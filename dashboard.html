<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <title>Dashboard | Sigara BÄ±rak</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="dashboard-body">
    <div class="dashboard-wrapper">
        <!-- Mobile Toggle -->
        <button class="mobile-toggle" id="mobileToggle">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="12" x2="21" y2="12"/>
                <line x1="3" y1="6" x2="21" y2="6"/>
                <line x1="3" y1="18" x2="21" y2="18"/>
            </svg>
        </button>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar -->
        <aside class="dashboard-sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="home.html" class="sidebar-logo">
                    <div class="sidebar-logo-icon">âœ“</div>
                    <span>Sigara BÄ±rak</span>
                </a>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Ana MenÃ¼</div>
                    <a href="dashboard.html" class="nav-item active">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"/>
                            <rect x="14" y="3" width="7" height="7"/>
                            <rect x="14" y="14" width="7" height="7"/>
                            <rect x="3" y="14" width="7" height="7"/>
                        </svg>
                        <span>Dashboard</span>
                    </a>
                    <a href="#" class="nav-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14,2 14,8 20,8"/>
                        </svg>
                        <span>Ä°lerlemem</span>
                    </a>
                    <a href="#" class="nav-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                        </svg>
                        <span>Tasarruf</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Topluluk</div>
                    <a href="#" class="nav-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        <span>Forum</span>
                    </a>
                    <a href="#" class="nav-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                        </svg>
                        <span>BaÅŸarÄ±lar</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Destek</div>
                    <a href="#" class="nav-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                        <span>Uzman DesteÄŸi</span>
                    </a>
                    <a href="#" class="nav-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                        <span>YardÄ±m</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar">AY</div>
                    <div class="user-info">
                        <div class="user-name">Ahmet YÄ±lmaz</div>
                        <div class="user-status">Ã‡evrimiÃ§i</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Header -->
            <header class="dashboard-header">
                <div class="header-title">
                    <h1>HoÅŸ Geldin, Ahmet! ğŸ‘‹</h1>
                    <p class="header-subtitle">SigarasÄ±z geÃ§en 45. gÃ¼nÃ¼n kutlu olsun!</p>
                </div>
                <div class="header-actions">
                    <button class="header-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                        </svg>
                    </button>
                    <button class="header-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                    </button>
                    <a href="index.html" class="header-btn btn-primary">Ã‡Ä±kÄ±ÅŸ Yap</a>
                </div>
            </header>

            <!-- Stats Grid -->
            <div class="dashboard-grid grid-cols-4">
                <div class="stat-card-dash success">
                    <div class="stat-header">
                        <span class="stat-title">SigarasÄ±z GÃ¼n</span>
                        <div class="stat-icon-dash success">ğŸ“…</div>
                    </div>
                    <div class="stat-value-dash">45</div>
                    <div class="stat-change positive">
                        <span>â†‘</span> 7 gÃ¼n Ã¶nce
                    </div>
                </div>

                <div class="stat-card-dash primary">
                    <div class="stat-header">
                        <span class="stat-title">Para Tasarrufu</span>
                        <div class="stat-icon-dash primary">ğŸ’°</div>
                    </div>
                    <div class="stat-value-dash">â‚º1.890</div>
                    <div class="stat-change positive">
                        <span>â†‘</span> Bu ay +â‚º420
                    </div>
                </div>

                <div class="stat-card-dash info">
                    <div class="stat-header">
                        <span class="stat-title">Ä°Ã§ilmeyen Sigara</span>
                        <div class="stat-icon-dash info">ğŸš­</div>
                    </div>
                    <div class="stat-value-dash">675</div>
                    <div class="stat-change positive">
                        <span>â†‘</span> 15 gÃ¼nde
                    </div>
                </div>

                <div class="stat-card-dash warning">
                    <div class="stat-header">
                        <span class="stat-title">SaÄŸlÄ±k Skoru</span>
                        <div class="stat-icon-dash warning">â¤ï¸</div>
                    </div>
                    <div class="stat-value-dash">85/100</div>
                    <div class="stat-change positive">
                        <span>â†‘</span> +12 puan
                    </div>
                </div>
            </div>

            <!-- Main Grid -->
            <div class="dashboard-grid grid-cols-2">
                <!-- Timer Card -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title">â±ï¸ SigarasÄ±z SÃ¼re</h3>
                        <div class="card-actions">
                            <button class="card-btn">PaylaÅŸ</button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="timer-display">
                            <div class="timer-value" id="timer">45:12:34:56</div>
                            <div class="timer-label">gÃ¼n : saat : dakika : saniye</div>
                            <div class="timer-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 45%"></div>
                                </div>
                                <div class="progress-labels">
                                    <span>0</span>
                                    <span>100 gÃ¼n hedefi</span>
                                </div>
                            </div>
                            <div class="milestone-badge">
                                <span>ğŸ†</span> Bir sonraki: 50 gÃ¼n
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Health Stats -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ’ª SaÄŸlÄ±k Durumu</h3>
                        <div class="card-actions">
                            <button class="card-btn">Detaylar</button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="health-stats">
                            <div class="health-stat">
                                <div class="health-stat-icon">ğŸ«</div>
                                <div class="health-stat-content">
                                    <div class="health-stat-label">AkciÄŸer Kapasitesi</div>
                                    <div class="health-stat-value">+15% Ä°yileÅŸti</div>
                                    <div class="health-stat-change">45 gÃ¼nde</div>
                                </div>
                            </div>
                            <div class="health-stat">
                                <div class="health-stat-icon">ğŸ«€</div>
                                <div class="health-stat-content">
                                    <div class="health-stat-label">Kalp Riski</div>
                                    <div class="health-stat-value">-25% AzaldÄ±</div>
                                    <div class="health-stat-change">45 gÃ¼nde</div>
                                </div>
                            </div>
                            <div class="health-stat">
                                <div class="health-stat-icon">ğŸ˜´</div>
                                <div class="health-stat-content">
                                    <div class="health-stat-label">Uyku Kalitesi</div>
                                    <div class="health-stat-value">+30% ArttÄ±</div>
                                    <div class="health-stat-change">30 gÃ¼nde</div>
                                </div>
                            </div>
                            <div class="health-stat">
                                <div class="health-stat-icon">âš¡</div>
                                <div class="health-stat-content">
                                    <div class="health-stat-label">Enerji Seviyesi</div>
                                    <div class="health-stat-value">+40% YÃ¼ksek</div>
                                    <div class="health-stat-change">45 gÃ¼nde</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Savings & Activity -->
            <div class="dashboard-grid grid-cols-2">
                <!-- Savings Calculator -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ’µ Tasarruf HesaplayÄ±cÄ±</h3>
                        <div class="card-actions">
                            <button class="card-btn">Ayarlar</button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="savings-display">
                            <div class="savings-amount">â‚º1.890</div>
                            <div class="savings-label">Toplam Tasarruf (45 gÃ¼n)</div>
                        </div>
                        <div class="savings-breakdown">
                            <div class="breakdown-item">
                                <div class="breakdown-value">â‚º42</div>
                                <div class="breakdown-label">GÃ¼nlÃ¼k</div>
                            </div>
                            <div class="breakdown-item">
                                <div class="breakdown-value">â‚º294</div>
                                <div class="breakdown-label">HaftalÄ±k</div>
                            </div>
                            <div class="breakdown-item">
                                <div class="breakdown-value">â‚º1.260</div>
                                <div class="breakdown-label">AylÄ±k</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ“‹ Son Aktiviteler</h3>
                        <div class="card-actions">
                            <button class="card-btn">TÃ¼mÃ¼</button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="activity-list">
                            <div class="activity-item">
                                <div class="activity-icon">ğŸ†</div>
                                <div class="activity-content">
                                    <div class="activity-title">30 GÃ¼n Rozeti KazanÄ±ldÄ±</div>
                                    <div class="activity-desc">SÃ¼rekli sigarasÄ±z 30 gÃ¼n baÅŸarÄ±mÄ±</div>
                                </div>
                                <div class="activity-time">2 gÃ¼n Ã¶nce</div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon">ğŸ’°</div>
                                <div class="activity-content">
                                    <div class="activity-title">â‚º1.000 Tasarruf</div>
                                    <div class="activity-desc">Ä°lk 1000 TL tasarruf kilometre taÅŸÄ±</div>
                                </div>
                                <div class="activity-time">5 gÃ¼n Ã¶nce</div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon">â¤ï¸</div>
                                <div class="activity-content">
                                    <div class="activity-title">SaÄŸlÄ±k Skoru ArttÄ±</div>
                                    <div class="activity-desc">SaÄŸlÄ±k skorunuz 85 puana yÃ¼kseldi</div>
                                </div>
                                <div class="activity-time">1 hafta Ã¶nce</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Achievements -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h3 class="card-title">ğŸ¯ BaÅŸarÄ±mlarÄ±m</h3>
                    <div class="card-actions">
                        <button class="card-btn">TÃ¼mÃ¼nÃ¼ GÃ¶r</button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="achievements-grid">
                        <div class="achievement-card unlocked">
                            <div class="achievement-icon">ğŸŒŸ</div>
                            <div class="achievement-title">Ä°lk AdÄ±m</div>
                            <div class="achievement-desc">1. gÃ¼n tamamlandÄ±</div>
                        </div>
                        <div class="achievement-card unlocked">
                            <div class="achievement-icon">ğŸ”¥</div>
                            <div class="achievement-title">AteÅŸ BaÅŸladÄ±</div>
                            <div class="achievement-desc">7. gÃ¼n tamamlandÄ±</div>
                        </div>
                        <div class="achievement-card unlocked">
                            <div class="achievement-icon">ğŸ’ª</div>
                            <div class="achievement-title">1 Ay GÃ¼cÃ¼</div>
                            <div class="achievement-desc">30. gÃ¼n tamamlandÄ±</div>
                        </div>
                        <div class="achievement-card locked">
                            <div class="achievement-icon">ğŸ‘‘</div>
                            <div class="achievement-title">AltÄ±n Ä°nsan</div>
                            <div class="achievement-desc">50. gÃ¼n kilidi</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chart Section -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“Š Ä°lerleme GrafiÄŸi</h3>
                    <div class="card-actions">
                        <button class="card-btn active">HaftalÄ±k</button>
                        <button class="card-btn">AylÄ±k</button>
                        <button class="card-btn">YÄ±llÄ±k</button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="chart-placeholder">
                        <div style="text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“ˆ</div>
                            <p>Grafik burada gÃ¶rÃ¼ntÃ¼lenecek</p>
                            <p style="font-size: 0.875rem; margin-top: 0.5rem;">(GerÃ§ek verilerle doldurulacak)</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/motivational.js"></script>
    <script src="js/share.js"></script>
    <script src="js/offline.js"></script>
    <script src="js/sos.js"></script>
    <script src="js/mood.js"></script>
    <script src="js/checkin.js"></script>
    <script src="js/healthcalc.js"></script>
    <script src="js/journal.js"></script>
    <script>
        // Initialize all systems
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Supabase first
            window.SupabaseConfig.init();
            
            // Check authentication
            const user = await window.SupabaseConfig.checkAuth();
            if (!user) {
                // Not logged in, redirect to login
                window.location.href = 'index.html';
                return;
            }
            
            console.log('âœ… Dashboard - KullanÄ±cÄ± giriÅŸ yapmÄ±ÅŸ:', user.email);
            
            // Update user name in sidebar
            const userNameEl = document.querySelector('.user-name');
            const userAvatarEl = document.querySelector('.user-avatar');
            if (userNameEl) {
                // Get profile info
                try {
                    const profile = await window.SupabaseConfig.profile.get(user.id);
                    if (profile) {
                        userNameEl.textContent = profile.full_name || user.email;
                        if (userAvatarEl && profile.full_name) {
                            userAvatarEl.textContent = profile.full_name.split(' ').map(n => n[0]).join('').toUpperCase();
                        }
                    }
                } catch (e) {
                    console.log('Profil bilgisi alÄ±namadÄ±');
                }
            }
            
            // Load quit smoking info
            try {
                const quitInfo = await window.SupabaseConfig.quitInfo.get(user.id);
                if (!quitInfo) {
                    // First time user - show setup modal or redirect to profile
                    console.log('Sigara bÄ±rakma bilgisi bulunamadÄ±');
                }
            } catch (e) {
                console.log('Quit info yÃ¼klenemedi');
            }
            
            // Load user data
            const storage = window.DataStorage;
            const progress = storage ? storage.calculateProgress() : null;
            
            const mainContent = document.querySelector('.dashboard-main');
            
            // Show motivational widget
            if (mainContent && window.MotivationalSystem) {
                const widget = window.MotivationalSystem.createWidget();
                mainContent.insertBefore(widget, mainContent.children[1]);
            }
            
            // Add Daily Check-in card
            if (mainContent && window.DailyCheckIn) {
                const checkinCard = window.DailyCheckIn.createCheckInCard();
                const grid = mainContent.querySelector('.dashboard-grid');
                if (grid) {
                    grid.parentNode.insertBefore(checkinCard, grid.nextSibling);
                }
            }
            
            // Add Mood Tracker card
            if (mainContent && window.MoodTracker) {
                const moodCard = window.MoodTracker.createMoodCard();
                const checkin = mainContent.querySelector('.checkin-card');
                if (checkin) {
                    checkin.parentNode.insertBefore(moodCard, checkin.nextSibling);
                }
            }
            
            // Add Health Calculator card
            if (mainContent && window.HealthCalculator) {
                const healthCard = window.HealthCalculator.createHealthCard();
                const mood = mainContent.querySelector('.mood-tracker-card');
                if (mood) {
                    mood.parentNode.insertBefore(healthCard, mood.nextSibling);
                }
            }
            
            // Add Journal card
            if (mainContent && window.JournalSystem) {
                const journalCard = window.JournalSystem.createJournalCard();
                const health = mainContent.querySelector('.health-calc-card');
                if (health) {
                    health.parentNode.insertBefore(journalCard, health.nextSibling);
                }
            }
            
            // Add SOS button
            if (window.SOSHelpSystem) {
                const sosBtn = window.SOSHelpSystem.createSOSButton();
                document.body.appendChild(sosBtn);
            }
            
            // Add share button
            const headerActions = document.querySelector('.header-actions');
            if (headerActions && window.ShareSystem) {
                const shareBtn = window.ShareSystem.createShareButton();
                shareBtn.className = 'header-btn';
                headerActions.insertBefore(shareBtn, headerActions.firstChild);
            }
            
            // Check for new achievements
            try {
                const newAchievements = await window.SupabaseConfig.achievements.checkNew(user.id);
                if (newAchievements && newAchievements.length > 0 && window.NotificationSystem) {
                    newAchievements.forEach(ach => {
                        setTimeout(() => {
                            window.NotificationSystem.showToast(
                                `ğŸ† ${ach.title} baÅŸarÄ±mÄ± kazandÄ±nÄ±z!`, 
                                'success', 
                                6000
                            );
                        }, 2000);
                    });
                }
            } catch (e) {
                console.log('BaÅŸarÄ±m kontrolÃ¼ yapÄ±lamadÄ±');
            }
            
            // Setup daily motivation
            if (window.MotivationalSystem) {
                window.MotivationalSystem.setupDailyReminders();
            }
        });

        // Mobile sidebar toggle
        const mobileToggle = document.getElementById('mobileToggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        mobileToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('active');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('active');
        });

        // Timer functionality with real data
        function updateTimer() {
            const storage = window.DataStorage;
            const progress = storage.calculateProgress();
            
            const timerEl = document.getElementById('timer');
            if (timerEl && progress) {
                timerEl.textContent = `${progress.days}:${String(progress.hours).padStart(2, '0')}:${String(progress.minutes).padStart(2, '0')}:${String(new Date().getSeconds()).padStart(2, '0')}`;
            }
        }

        setInterval(updateTimer, 1000);
        updateTimer();

        // Update stats from storage
        function updateStatsFromStorage() {
            const storage = window.DataStorage;
            if (!storage) return;
            
            const progress = storage.calculateProgress();
            if (!progress) return;
            
            // Update stat cards
            const statValues = document.querySelectorAll('.stat-value-dash');
            if (statValues.length >= 4) {
                statValues[0].textContent = progress.days;
                statValues[1].textContent = 'â‚º' + progress.moneySaved.toLocaleString();
                statValues[2].textContent = progress.cigarettesNotSmoked.toLocaleString();
                statValues[3].textContent = progress.healthScore + '/100';
            }
        }
        
        updateStatsFromStorage();
    </script>
</body>
</html>
